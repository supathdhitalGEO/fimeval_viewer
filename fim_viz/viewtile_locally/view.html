<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Vector PBF sanity check</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.vectorgrid/dist/Leaflet.VectorGrid.bundled.js"></script>
  <style>
    html, body, #map { height: 100%; margin: 0; }
    #log { position:absolute; z-index:1000; top:8px; left:8px;
           background:rgba(255,255,255,.95); padding:6px 8px; border-radius:6px;
           font:12px/1.3 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
  </style>
</head>
<body>
<div id="map"></div>
<div id="log">status: boot…</div>

<script>
const LOG = document.getElementById('log');
function log(s){ LOG.innerHTML = s; console.log(s); }

// IMPORTANT: these paths are relative to /viewtile_locally/view.html
const TILES_URL   = "../out_tiles/tiles/{z}/{x}/{y}.pbf";
const META_URL    = "../out_tiles/tiles/metadata.json";
const LAYER_NAME  = "fim_extents"; // must match metadata.json vector_layers[0].id

const map = L.map('map', { preferCanvas: true }).setView([38.9, -92.0], 6);
L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "&copy; OpenStreetMap contributors"
}).addTo(map);

log("adding vectorgrid…");

const vg = L.vectorGrid.protobuf(TILES_URL, {
  interactive: true,
  maxNativeZoom: 14,
  maxZoom: 22,
  rendererFactory: L.canvas.tile,
  fetchOptions: { mode: 'cors' },
  vectorTileLayerStyles: {
    [LAYER_NAME]: function(props){
      const colors = {
        "Tier_1":"#1b9e77","Tier_2":"#d95f02","Tier_3":"#7570b3",
        "Tier_4":"#e7298a","Tier_5":"#66a61e"
      };
      const c = colors[props.tier] || "#2c7fb8";
      return { color: c, weight: 1, fill: false, fillOpacity: 0.15 };
    }
  }
})
.on('load', () => log("tiles requested — check DevTools → Network for .pbf 200s"))
.on('click', (e) => {
  const p = (e.layer && e.layer.properties) || {};
  L.popup().setLatLng(e.latlng)
    .setContent(`<b>${p.tier||""}</b> — ${p.site_id||""}<br/>ID: ${p.feature_id||""}`)
    .openOn(map);
})
.on('tileerror', (err) => {
  log("tileerror — check console/network; common causes: wrong path or gzip header");
  console.error(err);
})
.addTo(map);

// Center the map on your tileset bounds/center
fetch(META_URL).then(r => r.json()).then(meta => {
  try {
    if (meta.center) {
      const [lon, lat, z] = meta.center.split(",").map(Number);
      if (isFinite(lat) && isFinite(lon)) map.setView([lat, lon], isFinite(z)? z : 8);
      log(`centered to metadata center`);
    } else if (meta.bounds) {
      const b = meta.bounds.split(",").map(Number); // west,south,east,north
      if (b.length === 4) {
        map.fitBounds([[b[1], b[0]], [b[3], b[2]]]);
        log(`fit to metadata bounds`);
      }
    }
  } catch(e){ console.warn("metadata parse issue", e); }
}).catch(() => { /* ignore */ });
</script>
</body>
</html>